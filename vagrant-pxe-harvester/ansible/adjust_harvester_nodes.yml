---
- name: set Harvester Node IP fact for new host group built
  set_fact:
    harvester_node_ip: "{{ harvester_network_config['cluster'][node_number | int]['ip'] }}"

- name: edit hosts with the docker registry domain on harvester node
  shell: |
    echo "" >> /etc/hosts && echo "{{ rancher_config.node_harvester_network_ip }} {{ rancher_config.registry_domain }} {{ rancher_config.rancher_install_domain }}" >> /etc/hosts

- name: copy rke2 registries over
  template:
    src: roles/harvester/templates/registries-edit.yaml.j2
    dest: /etc/rancher/rke2/registries.yaml
  register: copy_rke2_registries_yaml_result
  delegate_to: "{{ harvester_node_ip }}"
  ignore_errors: yes
  ignore_unreachable: yes

- name: restart rke2 service on harvester node 
  systemd:
    name: rke2-server.service
    state: restarted
  delegate_to: "{{ harvester_node_ip }}"
  ignore_errors: yes
  ignore_unreachable: yes
  register: rke2_harvester_node_restart_result


- name: copy rke2-coredns-rke2-coredns configmap edit over
  template:
    src: roles/harvester/templates/configmap-rke2-coredns-rke2-coredns.yaml.j2
    dest: /etc/rancher/rke2/patch-configmap-rke2-coredns-rke2-coredns.yaml
  delegate_to: "{{ harvester_node_ip }}"
  ignore_errors: yes
  ignore_unreachable: yes

- name: patch configmap rke2-coredns-rke2-coredns with updateded content
  shell: |
    /var/lib/rancher/rke2/bin/kubectl --kubeconfig /etc/rancher/rke2/rke2.yaml patch configmap/rke2-coredns-rke2-coredns -n kube-system \
    --patch-file /etc/rancher/rke2/patch-configmap-rke2-coredns-rke2-coredns.yaml
  delegate_to: "{{ harvester_node_ip }}"
  ignore_errors: yes
  ignore_unreachable: yes 

- name: copy rke2-coredns-rke2-coredns deployment edit over
  template:
    src: roles/harvester/templates/deployment-rke2-coredns-rke2-coredns.yaml.j2
    dest: /etc/rancher/rke2/deployment-rke2-coredns-rke2-coredns.yaml
  delegate_to: "{{ harvester_node_ip }}"
  ignore_errors: yes
  ignore_unreachable: yes

- name: patch deployment rke2-coredns-rke2-coredns with updated content
  shell: |
    /var/lib/rancher/rke2/bin/kubectl --kubeconfig /etc/rancher/rke2/rke2.yaml patch deployment/rke2-coredns-rke2-coredns -n kube-system \    
    --patch-file /etc/rancher/rke2/deployment-rke2-coredns-rke2-coredns.yaml
  delegate_to: "{{ harvester_node_ip }}"
  ignore_errors: yes
  ignore_unreachable: yes
    

#     -p '{"spec": {"template": {"spec":{"affinity":{"podAntiAffinity":{"requiredDuringSchedulingIgnoredDuringExecution":[{"labelSelector":{"matchExpressions":[{"key":"k8s-app","operator":"In","values":["kube-dns"]}]},"topologyKey":"kubernetes.io/hostname"}]}},"containers":[{"args":["-conf","/etc/coredns/Corefile"],"image":"{{ rancher_config.harvester_coredns_build }}","imagePullPolicy":"IfNotPresent","livenessProbe":{"failureThreshold":5,"httpGet":{"path":"/health","port":8080,"scheme":"HTTP"},"initialDelaySeconds":60,"periodSeconds":10,"successThreshold":1,"timeoutSeconds":5},"name":"coredns","ports":[{"containerPort":53,"name":"udp-53","protocol":"UDP"},{"containerPort":53,"name":"tcp-53","protocol":"TCP"}],"readinessProbe":{"failureThreshold":5,"httpGet":{"path":"/ready","port":8181,"scheme":"HTTP"},"initialDelaySeconds":30,"periodSeconds":10,"successThreshold":1,"timeoutSeconds":5},"resources":{"limits":{"cpu":"100m","memory":"128Mi"},"requests":{"cpu":"100m","memory":"128Mi"}},"terminationMessagePath":"/dev/termination-log","terminationMessagePolicy":"File","volumeMounts":[{"mountPath":"/etc/coredns","name":"config-volume"}]}],"dnsPolicy":"Default","nodeSelector":{"kubernetes.io/os":"linux"},"priorityClassName":"system-cluster-critical","restartPolicy":"Always","schedulerName":"default-scheduler","securityContext":{},"serviceAccount":"coredns","serviceAccountName":"coredns","terminationGracePeriodSeconds":30,"tolerations":[{"key":"CriticalAddonsOnly","operator":"Exists"},{"effect":"NoSchedule","key":"node-role.kubernetes.io/control-plane","operator":"Exists"},{"effect":"NoExecute","key":"node-role.kubernetes.io/etcd","operator":"Exists"}],"volumes":[{"configMap":{"defaultMode":420,"items":[{"key":"Corefile","path":"Corefile"},{"key":"customdomains.db","path":"customdomains.db"}],"name":"rke2-coredns-rke2-coredns"},"name":"config-volume"}]}}}}'
    